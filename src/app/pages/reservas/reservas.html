<app-navbar></app-navbar>

<!-- Hero Section -->
<section class="reservas-hero">
    <div class="hero-overlay"></div>
    <div class="container">
        <div class="hero-content">
            <div class="hero-pill">
                <div class="pill-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <span>Reserva fácil y segura</span>
            </div>
            <h1 class="page-title">
                Sistema de Reservas
                <span>Tu aventura comienza aquí</span>
            </h1>
            <p class="page-subtitle">
                Proceso simple y rápido para reservar tu experiencia perfecta en Andahuaylas
            </p>
            <div class="hero-stats">
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">100%</span>
                        <span class="stat-label">Seguro</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">24h</span>
                        <span class="stat-label">Confirmación</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">0%</span>
                        <span class="stat-label">Comisión</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Reservation Type Selector -->
<section class="reservation-type-selector">
    <div class="container">
        <h2 class="section-title">¿Qué deseas reservar?</h2>
        <p class="section-subtitle">Selecciona el tipo de servicio que necesitas</p>
        
        <div class="type-selector-grid">
            @for (type of reservationTypes; track type.id) {
                <div 
                    class="type-card"
                    [class.active]="selectedType() === type.id"
                    (click)="selectType(type.id)">
                    <div class="type-icon">
                        <i class="fas" [class]="type.icon"></i>
                    </div>
                    <h3>{{ type.title }}</h3>
                    <p>{{ type.subtitle }}</p>
                    <div class="type-benefits">
                        @for (benefit of type.benefits; track benefit) {
                            <span>
                                <i class="fas fa-check"></i>
                                {{ benefit }}
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<!-- Reservation Form -->
<section class="reservation-form-section">
    <div class="container">
        <div class="form-container">
            <!-- Progress -->
            <div class="form-progress">
                <div class="progress-step" [class.active]="currentStep() >= 1" [class.completed]="currentStep() > 1">
                    <span class="step-number">1</span>
                    <span class="step-label">Detalles</span>
                </div>
                <div class="progress-line" [class.completed]="currentStep() > 1"></div>
                <div class="progress-step" [class.active]="currentStep() >= 2" [class.completed]="currentStep() > 2">
                    <span class="step-number">2</span>
                    <span class="step-label">Información</span>
                </div>
                <div class="progress-line" [class.completed]="currentStep() > 2"></div>
                <div class="progress-step" [class.active]="currentStep() >= 3">
                    <span class="step-number">3</span>
                    <span class="step-label">Confirmación</span>
                </div>
            </div>

            <!-- Step 1: Reservation Details -->
            @if (currentStep() === 1) {
                <div class="form-step active">
                    <div class="step-header">
                        <h2>
                            <i class="fas fa-info-circle"></i>
                            Detalles de tu Reserva
                        </h2>
                        <p>Especifica las fechas y número de participantes</p>
                    </div>

                    <form class="reservation-form">
                        @if (selectedType() === 'destination') {
                            <div class="form-section">
                                <h4><i class="fas fa-map-marker-alt"></i> Destino</h4>
                                <div class="form-group">
                                    <select [(ngModel)]="reservationDetails.destination" name="destination" required>
                                        <option value="">Selecciona un destino</option>
                                        @for (dest of destinations; track dest) {
                                            <option [value]="dest">{{ dest }}</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        }

                        @if (servicioSeleccionado()) {
                            <div class="form-section servicio-preseleccionado">
                                <h4><i class="fas fa-tag"></i> Servicio Seleccionado</h4>
                                <div class="servicio-info-box">
                                    <div class="servicio-nombre">
                                        <i class="fas" [ngClass]="{
                                            'fa-hotel': selectedType() === 'accommodation',
                                            'fa-car': selectedType() === 'transport',
                                            'fa-map-marked-alt': selectedType() === 'destination',
                                            'fa-gift': selectedType() === 'package',
                                            'fa-utensils': selectedType() === 'gastronomy'
                                        }"></i>
                                        {{ servicioSeleccionado() }}
                                    </div>
                                    @if (precioBase() > 0) {
                                        <div class="servicio-precio">
                                            S/ {{ precioBase().toFixed(2) }} <span>por noche/día</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <div class="form-section">
                            <h4><i class="fas fa-calendar"></i> Fechas</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Fecha de Inicio</label>
                                    <input 
                                        type="date" 
                                        [(ngModel)]="reservationDetails.startDate"
                                        (ngModelChange)="onFormChange()"
                                        name="startDate"
                                        [min]="minDate"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Fecha de Fin</label>
                                    <input 
                                        type="date" 
                                        [(ngModel)]="reservationDetails.endDate"
                                        (ngModelChange)="onFormChange()"
                                        name="endDate"
                                        [min]="reservationDetails.startDate || minDate"
                                        required>
                                </div>
                            </div>
                            @if (totalDays() > 0) {
                                <div class="info-box">
                                    <i class="fas fa-info-circle"></i>
                                    Duración: <strong>{{ totalDays() }} día(s)</strong>
                                </div>
                            }
                        </div>

                        <div class="form-section">
                            <h4><i class="fas fa-users"></i> Participantes</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Adultos (mayores de 12 años)</label>
                                    <select [(ngModel)]="reservationDetails.adults" (ngModelChange)="onFormChange()" name="adults" required>
                                        <option [ngValue]="1">1 Adulto</option>
                                        <option [ngValue]="2">2 Adultos</option>
                                        <option [ngValue]="3">3 Adultos</option>
                                        <option [ngValue]="4">4 Adultos</option>
                                        <option [ngValue]="5">5 Adultos</option>
                                        <option [ngValue]="6">6+ Adultos</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Niños (menores de 12 años)</label>
                                    <select [(ngModel)]="reservationDetails.children" (ngModelChange)="onFormChange()" name="children">
                                        <option [ngValue]="0">Sin niños</option>
                                        <option [ngValue]="1">1 Niño</option>
                                        <option [ngValue]="2">2 Niños</option>
                                        <option [ngValue]="3">3 Niños</option>
                                        <option [ngValue]="4">4+ Niños</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        @if (isStepValid(1)) {
                            <div class="price-estimate">
                                <div class="estimate-label">
                                    <i class="fas fa-calculator"></i>
                                    Precio Estimado
                                </div>
                                <div class="estimate-breakdown">
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">Adultos:</span>
                                        <span class="breakdown-value">{{ reservationDetails.adults }} × S/ {{ precioUnitario().toFixed(2) }} = S/ {{ (reservationDetails.adults * precioUnitario() * (totalDays() || 1)).toFixed(2) }}</span>
                                    </div>
                                    @if (reservationDetails.children > 0) {
                                        <div class="breakdown-row">
                                            <span class="breakdown-label">Niños (50%):</span>
                                            <span class="breakdown-value">{{ reservationDetails.children }} × S/ {{ (precioUnitario() * 0.5).toFixed(2) }} = S/ {{ (reservationDetails.children * precioUnitario() * 0.5 * (totalDays() || 1)).toFixed(2) }}</span>
                                        </div>
                                    }
                                    @if ((totalDays() || 1) > 1) {
                                        <div class="breakdown-row">
                                            <span class="breakdown-label">Duración:</span>
                                            <span class="breakdown-value">{{ totalDays() }} día(s)</span>
                                        </div>
                                    }
                                    <div class="breakdown-divider"></div>
                                    <div class="breakdown-row">
                                        <span class="breakdown-label"><strong>Subtotal:</strong></span>
                                        <span class="breakdown-value"><strong>S/ {{ estimatedPrice().toFixed(2) }}</strong></span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">IGV (18%):</span>
                                        <span class="breakdown-value">S/ {{ (estimatedPrice() * 0.18).toFixed(2) }}</span>
                                    </div>
                                    <div class="breakdown-divider"></div>
                                </div>
                                <div class="estimate-value">
                                    S/ {{ (estimatedPrice() * 1.18).toFixed(2) }}
                                </div>
                                <div class="estimate-note">
                                    * Precio incluye IGV. Puede variar según servicios adicionales.
                                </div>
                            </div>
                        }

                        <div class="form-actions">
                            <button 
                                type="button" 
                                class="btn btn-primary"
                                [disabled]="!isStepValid(1)"
                                (click)="nextStep()">
                                Continuar
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
            }

            <!-- Step 2: Personal Information -->
            @if (currentStep() === 2) {
                <div class="form-step active">
                    <div class="step-header">
                        <h2>
                            <i class="fas fa-user-circle"></i>
                            Información Personal
                        </h2>
                        <p>Ingresa tus datos para completar la reserva</p>
                    </div>

                    <form class="reservation-form">
                        <div class="form-section">
                            <h4><i class="fas fa-id-card"></i> Datos Personales</h4>
                            <div class="form-group">
                                <label>Nombre Completo</label>
                                <input 
                                    type="text" 
                                    [(ngModel)]="personalInfo.fullName"
                                    name="fullName"
                                    placeholder="Tu nombre completo"
                                    required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Correo Electrónico</label>
                                    <input 
                                        type="email" 
                                        [(ngModel)]="personalInfo.email"
                                        name="email"
                                        placeholder="tu@email.com"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Teléfono</label>
                                    <input 
                                        type="tel" 
                                        [(ngModel)]="personalInfo.phone"
                                        name="phone"
                                        placeholder="+51 999 999 999"
                                        required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>DNI o Documento de Identidad</label>
                                <input 
                                    type="text" 
                                    [(ngModel)]="personalInfo.document"
                                    name="document"
                                    placeholder="Número de documento"
                                    required>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4><i class="fas fa-comment-alt"></i> Solicitudes Especiales (Opcional)</h4>
                            <div class="form-group">
                                <textarea 
                                    [(ngModel)]="personalInfo.specialRequests"
                                    name="specialRequests"
                                    rows="4"
                                    placeholder="¿Alguna necesidad especial? (dieta, movilidad, alergias, etc.)"></textarea>
                            </div>
                        </div>

                        <!-- Resumen -->
                        <div class="reservation-summary">
                            <h4><i class="fas fa-clipboard-list"></i> Resumen de tu Reserva</h4>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-label">Tipo:</span>
                                    <span class="summary-value">{{ selectedType() === 'package' ? 'Paquete Completo' : 
                                                                       selectedType() === 'destination' ? 'Solo Destinos' :
                                                                       selectedType() === 'accommodation' ? 'Solo Hospedaje' :
                                                                       selectedType() === 'gastronomy' ? 'Gastronomía' : 'Solo Transporte' }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Fechas:</span>
                                    <span class="summary-value">{{ reservationDetails.startDate }} - {{ reservationDetails.endDate }}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Participantes:</span>
                                    <span class="summary-value">{{ totalParticipants() }} persona(s)</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Precio Total:</span>
                                    <span class="summary-value total">S/ {{ estimatedPrice().toFixed(2) }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button 
                                type="button" 
                                class="btn btn-secondary"
                                (click)="previousStep()">
                                <i class="fas fa-arrow-left"></i>
                                Atrás
                            </button>
                            <button 
                                type="button" 
                                class="btn btn-primary"
                                [disabled]="!isStepValid(2) || isSubmitting()"
                                (click)="submitReservation()">
                                @if (isSubmitting()) {
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Procesando...
                                } @else {
                                    <i class="fas fa-check-circle"></i>
                                    Confirmar Reserva
                                }
                            </button>
                        </div>
                    </form>
                </div>
            }

            <!-- Step 3: Confirmation -->
            @if (currentStep() === 3 && reservationComplete()) {
                <div class="form-step active">
                    <div class="confirmation-success">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h2>¡Reserva Confirmada!</h2>
                        <p>Tu reserva ha sido procesada exitosamente</p>
                        
                        <div class="confirmation-code">
                            <span class="code-label">Código de Confirmación</span>
                            <span class="code-value">{{ confirmationCode() }}</span>
                        </div>

                        <!-- Error al generar comprobante -->
                        @if (comprobanteError(); as error) {
                            <div class="comprobante-error">
                                <div class="error-content">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div class="error-text">
                                        <h4>No se pudo generar el comprobante</h4>
                                        <p>{{ error }}</p>
                                        <p class="error-note">Tu reserva fue creada correctamente. Puedes intentar generar el comprobante nuevamente.</p>
                                    </div>
                                </div>
                                <button 
                                    type="button" 
                                    class="btn btn-retry" 
                                    (click)="reintentarComprobante()"
                                    [disabled]="isSubmitting()">
                                    @if (isSubmitting()) {
                                        <i class="fas fa-spinner fa-spin"></i>
                                        Generando...
                                    } @else {
                                        <i class="fas fa-redo"></i>
                                        Reintentar generar comprobante
                                    }
                                </button>
                            </div>
                        }

                        <!-- Comprobante de Pago -->
                        @if (comprobanteGenerado(); as comprobante) {
                            <div class="comprobante-card">
                                <div class="comprobante-header">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <h3>Comprobante de Pago</h3>
                                </div>
                                
                                <div class="comprobante-body">
                                    <div class="comprobante-row">
                                        <span class="label">Nº Comprobante:</span>
                                        <span class="value codigo">{{ comprobante.codigoComprobante }}</span>
                                    </div>
                                    <div class="comprobante-row highlight">
                                        <span class="label">Código de Verificación:</span>
                                        <span class="value verification-code">{{ comprobante.codigoVerificacion }}</span>
                                    </div>
                                    <div class="comprobante-row">
                                        <span class="label">Cliente:</span>
                                        <span class="value">{{ comprobante.clienteNombre }}</span>
                                    </div>
                                    <div class="comprobante-row">
                                        <span class="label">Documento:</span>
                                        <span class="value">{{ comprobante.clienteDocumento }}</span>
                                    </div>
                                    <div class="comprobante-row">
                                        <span class="label">Servicio:</span>
                                        <span class="value">{{ comprobante.descripcionServicio }}</span>
                                    </div>
                                    <div class="comprobante-divider"></div>
                                    <div class="comprobante-row">
                                        <span class="label">Subtotal:</span>
                                        <span class="value">S/ {{ comprobante.subtotal.toFixed(2) }}</span>
                                    </div>
                                    <div class="comprobante-row">
                                        <span class="label">IGV (18%):</span>
                                        <span class="value">S/ {{ comprobante.impuestos.toFixed(2) }}</span>
                                    </div>
                                    <div class="comprobante-row total">
                                        <span class="label">TOTAL:</span>
                                        <span class="value">S/ {{ comprobante.total.toFixed(2) }}</span>
                                    </div>
                                </div>

                                <div class="comprobante-footer">
                                    <div class="verification-notice">
                                        <i class="fas fa-shield-alt"></i>
                                        <p>Guarda tu <strong>código de verificación</strong>. El proveedor del servicio lo usará para validar tu comprobante.</p>
                                    </div>

                                    <div class="comprobante-actions">
                                        <button type="button" class="btn btn-primary" (click)="descargarComprobantePdf()">
                                            <i class="fas fa-file-pdf"></i>
                                            Descargar comprobante (PDF)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="confirmation-info">
                            <div class="info-item">
                                <i class="fas fa-envelope"></i>
                                <p>Hemos enviado un correo de confirmación a <strong>{{ personalInfo.email }}</strong></p>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-phone"></i>
                                <p>Te contactaremos al <strong>{{ personalInfo.phone }}</strong> para coordinar detalles</p>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar-check"></i>
                                <p>Tu reserva está programada del <strong>{{ reservationDetails.startDate }}</strong> al <strong>{{ reservationDetails.endDate }}</strong></p>
                            </div>
                        </div>

                        <div class="next-steps">
                            <h3>Próximos Pasos</h3>
                            <ol>
                                <li>Recibirás un correo con los detalles completos de tu reserva</li>
                                <li>Un agente te contactará en las próximas 24 horas para confirmar</li>
                                <li>Podrás realizar el pago mediante transferencia o en oficina</li>
                                <li>Presenta tu código de verificación al momento de usar el servicio</li>
                            </ol>
                        </div>

                        <div class="form-actions">
                            <a routerLink="/" class="btn btn-secondary">
                                <i class="fas fa-home"></i>
                                Ir al Inicio
                            </a>
                            <button 
                                type="button" 
                                class="btn btn-primary"
                                (click)="resetForm()">
                                <i class="fas fa-plus"></i>
                                Nueva Reserva
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<app-footer></app-footer>
